# OCTA 血管网络分析系统 - 使用指南

## 1. 快速开始

### 1.1 启动系统

**方式一：一键启动**
```bash
双击 scripts/start.bat
```

**方式二：手动启动**
```bash
# 终端1：启动后端
cd backend
python -m uvicorn api.main:app --host 127.0.0.1 --port 8000 --reload

# 终端2：启动前端
cd frontend
npm run dev
```

访问 http://localhost:5173

## 2. 功能模块

### 2.1 数据管理

**支持的数据格式**：
- DICOM 单文件 (.dcm, .dicom)
- DICOM 序列（ZIP 压缩包）
- NIfTI (.nii, .nii.gz)
- NumPy 数组 (.npy)
- MATLAB v7.3 (.mat)

**操作步骤**：
1. 进入「数据管理」页面
2. 点击上传区域或拖放文件
3. 等待数据解析完成
4. 选择数据查看切片预览

### 2.2 标注工具

**标注工具**：
- **椭圆工具**：绘制血管横截面的理想形状
- **画笔工具**：自由绘制或涂抹
- **橡皮擦**：擦除错误标注
- **平移工具**：拖动查看不同区域

**标注流程**：
1. 选择要标注的数据
2. 切换到 Y 轴（B-scan 视图）
3. 滚动到包含血管的切片
4. 使用椭圆工具标注血管横截面
5. 保存标注
6. 重复直到标注足够样本
7. 点击「生成金标准」

**技巧**：
- 开启「显示畸变矫正」可以看到校正后的图像
- 使用快捷键 Ctrl+Z / Ctrl+Y 撤销/重做
- 标注时关注血管的真实边界，忽略拖尾部分

### 2.3 模型训练

**训练模式**：
- **分割网络**：3D U-Net，快速训练
- **扩散网络**：Diffusion 模型，生成质量更高
- **级联训练**：先分割后扩散，推荐

**推荐配置**：
| 参数 | 推荐值 | 说明 |
|------|--------|------|
| Epochs | 100 | 分割网络 |
| Epochs | 50 | 扩散网络 |
| Batch Size | 4 | 8GB 显存 |
| Patch Size | 32 | 平衡速度和精度 |
| Learning Rate | 1e-4 | 默认值 |

**训练技巧**：
- 监控验证 Loss 曲线，避免过拟合
- 定期保存检查点
- 如果 Loss 不下降，尝试降低学习率

### 2.4 推理预测

**推理流程**：
1. 选择输入数据
2. 选择训练好的模型检查点
3. 配置推理参数
4. 点击「开始推理」
5. 等待推理完成
6. 对比原始和结果

**参数说明**：
- **阈值**：二值化阈值，0.5 通常效果最好
- **DDIM 采样**：加速扩散推理，推荐开启
- **DDIM 步数**：50 步通常足够

### 2.5 三维可视化

**功能**：
- 旋转：左键拖动
- 缩放：滚轮
- 平移：右键拖动

**显示模式**：
- 深度着色：浅层绿色，深层红色
- 单色：统一颜色
- 线框模式：显示网格结构

**导出格式**：
- STL：适用于 3D 打印
- PLY：包含颜色信息
- OBJ：通用 3D 格式

## 3. 几何畸变矫正

### 3.1 问题说明

OCT 成像的纵向刻度基于光学路径长度，而非物理长度。当样品表面倾斜时：
- 光程变长
- 结构在纵向被拉伸
- 圆形血管变成椭圆或带拖尾

### 3.2 矫正原理

系统采用三步矫正：
1. **表面检测**：自动估计倾斜角度
2. **倾斜校正**：根据角度压缩纵向
3. **折射率补偿**：根据组织折射率调整

### 3.3 使用方法

在标注工具中：
- 勾选「显示畸变矫正」查看校正后图像
- 对比校正前后的血管形状
- 基于校正后的图像进行标注

## 4. 常见问题

### Q: 后端启动失败？
A: 检查端口 8000 是否被占用，或检查 Python 依赖是否安装完整。

### Q: 前端白屏？
A: 确保后端服务正在运行，检查浏览器控制台错误信息。

### Q: 训练很慢？
A: 确保使用 GPU，减小 batch size 或 patch size。

### Q: 推理结果不理想？
A: 增加训练 epochs，检查标注质量，尝试调整阈值。

### Q: 内存不足？
A: 减小 batch size，使用更小的 patch size。

## 5. 技术支持

如遇问题，请提供：
- 系统信息（操作系统、Python/Node 版本）
- 错误日志
- 复现步骤

联系方式：[待补充]
